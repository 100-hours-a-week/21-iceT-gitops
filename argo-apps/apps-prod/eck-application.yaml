apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: eck-stack
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/elastic/helm-charts.git
    targetRevision: main
    path: elasticsearch
    helm:
      values: |
        replicas: 1
        minimumMasterNodes: 1
        esConfig:
          elasticsearch.yml: |
            node.store.allow_mmap: false
        tls:
          selfSignedCertificate:
            enabled: true
  destination:
    server: https://kubernetes.default.svc
    namespace: elk
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kibana
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/elastic/helm-charts.git
    targetRevision: main
    path: kibana
    helm:
      values: |
        imageTag: 8.5.1
        elasticsearchHosts: "https://elasticsearch-master:9200"
        elasticsearchSSLVerificationMode: none
        ingress:
          enabled: true
          className: alb
          annotations:
            alb.ingress.kubernetes.io/scheme: internet-facing
            alb.ingress.kubernetes.io/target-type: ip
            alb.ingress.kubernetes.io/group.name: koco-alb-group
            alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
            alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:266735804784:certificate/5f2a8c3b-a576-4295-84c1-beb75ca562d9
            alb.ingress.kubernetes.io/backend-protocol: HTTP
          hosts:
            - host: kibana.koco-test.click
              paths:
                - path: /
                  pathType: Prefix
        
  destination:
    server: https://kubernetes.default.svc
    namespace: elk
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: apm-server
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/elastic/helm-charts.git
    targetRevision: main
    path: apm-server
    helm:
      values: |
        imageTag: 8.5.1
        elasticsearchHosts: "http://elasticsearch-master:9200"
        ingress:
          enabled: true
          className: alb
          annotations:
            alb.ingress.kubernetes.io/scheme: internet-facing
            alb.ingress.kubernetes.io/target-type: ip
            alb.ingress.kubernetes.io/group.name: koco-alb-group
            alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
            alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:266735804784:certificate/5f2a8c3b-a576-4295-84c1-beb75ca562d9
            alb.ingress.kubernetes.io/backend-protocol: HTTP
          hosts:
            - apm.koco-test.click
          pathType: Prefix            
          ingressPath: /
          
  destination:
    server: https://kubernetes.default.svc
    namespace: elk
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: logstash
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/elastic/helm-charts.git
    targetRevision: main
    path: logstash
    helm:
      values: |
        imageTag: 8.5.1
        logstashConfig:
          logstash.conf: |
            input { stdin {} }
            output { stdout {} }
  destination:
    server: https://kubernetes.default.svc
    namespace: elk
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: filebeat
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/elastic/helm-charts.git
    targetRevision: main
    path: filebeat
    helm:
      values: |
        imageTag: 8.5.1
        daemonset:
          enabled: true
        deployment:
          enabled: false
        filebeatConfig:
          filebeat.yml: |
            filebeat.inputs:
              - type: log
                enabled: true
                paths:
                  - /var/log/*.log
            output.elasticsearch:
              hosts: ["http://elasticsearch-master:9200"]
  destination:
    server: https://kubernetes.default.svc
    namespace: elk
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: metricbeat
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/elastic/helm-charts.git
    targetRevision: main
    path: metricbeat
    helm:
      values: |
        imageTag: 8.5.1
        daemonset:
          enabled: true
        deployment:
          enabled: false
        metricbeatConfig:
          metricbeat.yml: |
            metricbeat.modules:
              - module: system
                metricsets:
                  - cpu
                  - memory
                  - network
                  - filesystem
                period: 10s
            output.elasticsearch:
              hosts: ["http://elasticsearch-master:9200"]
  destination:
    server: https://kubernetes.default.svc
    namespace: elk
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
